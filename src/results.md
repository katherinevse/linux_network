## Part 1. Инструмент ipcalc

### 1.1. Сети и маски

1) Адрес сети 192.167.38.54/13
```
ipcalc 192.167.38.54/13
```
![](screenshots/task1_1.png)
Адресом сети (подсети) будет являться 192.167.38.0

2) Перевод маски 255.255.255.0 в префиксную и двоичную запись:
Префиксная - /24
Двоичная -  11111111.11111111.11111111.00000000

/15 в обычную и двоичную:
Обычная - 255.254.0.0
Двоичная - 11111111.11111110.00000000.00000000

11111111.11111111.11111111.11110000 в обычную и префиксную:
Обычная - 255.255.255.240
Префиксная - /28

![](screenshots/task1_2.png)

3) Минимальный и максимальный хост в сети 12.167.38.4 при масках: /8, 11111111.11111111.00000000.00000000, 255.255.254.0 и /4
Согласно стандартам TCP/IP адрес хоста не может состоять полностью из одинаковых битов (некоторым, типа Microsoft на это плевать и там все равно можно использовать такие адреса. Но это особенность именно компов с управлением ОС Микры. Так как выполнение идет на линухе, последний бит всегда для краевых случаев резервируем для другого значения относительно всего адреса хоста)
(Оставлю тут посхалку в виде shootnick, который тут, т. е. в этом задании, поможет)

/8 -  12.0.0.1 и 12.255.255.254

11111111.11111111.00000000.00000000 - 12.167.0.1 и 12.167.255.254

255.255.254.0 - 12.167.38.1 и 12.167.39.254

/4 - 0.0.0.1 и 15.255.255.254

### 1.2. localhost

Можно ли обратиться к приложению, работающему на localhost, со следующими IP: 194.34.23.100, 127.0.0.2, 127.1.0.1, 128.0.0.1

localhost (так называемый, «местный» от англ. local, или «локальный хост», по смыслу — этот компьютер) — в компьютерных сетях, стандартное, официально зарезервированное доменное имя для частных IP-адресов (в диапазоне 127.0.0.1 — 127.255.255.254, RFC 2606). Для сети, состоящей только из одного компьютера, как правило, используется всего один адрес — 127.0.0.1, который устанавливается на специальный сетевой интерфейс «внутренней петли» (англ. loopback) в сетевом протоколе TCP/IP. В Unix-подобных системах данный интерфейс обычно именуется «loN», где N — число, либо просто «lo». Это было изучено в прошлом проекте данной ветки.
Тогда получаем, что с адресами 127.0.0.2, 127.1.0.1 можно будет обратиться к данному приложению, а с адресами 194.34.23.100, 128.0.0.1 - не получится, так как они находятся за пределами выделенного диапазона.

### 1.3. Диапазоны и сегменты сетей

1) Какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: 10.0.0.45, 134.43.0.2, 192.168.4.2, 172.20.250.4, 172.0.2.1, 192.172.0.1, 172.68.0.2, 172.16.255.255, 10.10.10.10, 192.169.168.1

Есть специальные диапазоны адресов которые можно свободно использовать в своих сетях-
10.0.0.0 — 10.255.255.255
100.64.0.0 — 100.127.255.255
172.16.0.0 — 172.31.255.255
192.168.0.0 — 192.168.255.255
Это так называемые серые или частные IP адреса. Эти адреса не маршрутизируются в глобальной сети.
Т.е у вас может быть адрес 192.168.0.1, у вашего соседа такой же адрес, и вообще миллионы устройств с таким адресом.
Но попасть на такой адрес можно только из локальной сети, из интернета он недоступен.
Тогда получаем, что:
Можно в качестве публичных:
134.43.0.2, 172.0.2.1, 192.172.0.1, 172.68.0.2, 192.169.168.1
Можно только в качестве частных:
10.0.0.45, 192.168.4.2, 172.20.250.4, 10.10.10.10
Нельзя нигде (адрес хоста вероятнее всего имеет одинаковые биты)
172.16.255.255
Если необходимо и его разбить на одну из двух категорий, то он будет частным.

2) Какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18: 10.0.0.1, 10.10.0.2, 10.10.10.10, 10.10.100.1, 10.10.1.255
В случае подобной конфигурации схема адресации будет следующая:
00001010.00001010.00000000.00000000 - IP
11111111.11111111.11000000.00000000 - маска
Допустимые адреса хостов в данной сети:
10.10.0.1 - 10.10.63.254
Тогда возможные адреса:
10.10.0.2, 10.10.10.10, 10.10.1.255
Невозможные адреса:
10.0.0.1, 10.10.100.1


## Part 2. Статическая маршрутизация между двумя машинами

Сетевые интерфейсы первой машины:
![](screenshots/task2_1.png)

Сетевые интерфейсы второй машины:
![](screenshots/task2_2.png)

Измененные интерфейсы, вывод конфигурационного файла и команда на обновление сервиса сети для машины 1:
![](screenshots/task2_3.png)

Измененные интерфейсы, вывод конфигурационного файла и команда на обновление сервиса сети для машины 2:
![](screenshots/task2_4.png)

Добавление статического маршрута между машинами и пингование соединения для машины 1:
![](screenshots/task2_7.png)
![](screenshots/task2_5.png)

Добавление статического маршрута между машинами и пингование соединения для машины 2:
![](screenshots/task2_8.png)
![](screenshots/task2_6.png)

Добавление динамического маршрута между машинами и пингование соединения для машины 1:
![](screenshots/task2_9.png)
![](screenshots/task2_10.png)

Добавление динамического маршрута между машинами и пингование соединения для машины 2:
![](screenshots/task2_11.png)
![](screenshots/task2_12.png)

## Part 3. Утилита iperf3

### 3.1. Скорость соединения

Переведи и запиши в отчёт: 8 Mbps в MB/s, 100 MB/s в Kbps, 1 Gbps в Mbps.
8 Mbps = 1 MB/s
100 MB/s = 819200 Kbps
1 Gbps = 1024 Mbps

### 3.2. Утилита iperf3

Измерь скорость соединения между ws1 и ws2.
![](screenshots/task3_1.png)
![](screenshots/task3_2.png)

## Part 4. Сетевой экран

### 4.1. Утилита iptables

Создадим файл /etc/firewall.sh, имитирующий фаерволл, на ws1 и ws2:

Нужно добавить в созданный файл подряд следующие правила:

1) На ws1 примени стратегию, когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5).

2) На ws2 примени стратегию, когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5).

3) Открой на машинах доступ для порта 22 (ssh) и порта 80 (http).

4) Запрети echo reply (машина не должна «пинговаться», т.е. должна быть блокировка на OUTPUT).

5) Разреши echo reply (машина должна «пинговаться»).

Таким образом, файлы будут отличаться только строчками, отвечающими за пункты 4 и 5 (они будут заменены)

![](screenshots/task4_1.png)

Запустим файлы на обеих машинах 

![](screenshots/task4_2.png)

Опишем разницу между стратегиями, применёнными в первом и втором файлах.
Разница заключается в порядке выдачи и "забирании" права на "пингование". В одном случае, если мы сначала запрещаем, а потом разрешаем, результатом будет невозможность пинговать данную машину. Абсолютно обратная ситуация происходит во второй машине.

### 4.2. Утилита nmap

Командой ping найдем машину, которая не «пингуется», после чего утилитой nmap покажем, что хост машины запущен.
Проверка: в выводе nmap должно быть сказано: Host is up.

Вывод с первой машины
![](screenshots/task4_3.png)

Вывод со второй машины
![](screenshots/task4_4.png)

## Part 5. Статическая маршрутизация сети

### 5.1. Настройка адресов машин

Настройка сети согласно рисунку
![](screenshots/task5_1.png)
![](screenshots/task5_2.png)
![](screenshots/task5_3.png)

Проверка командой ip -4 а
![](screenshots/task5_4.png)
![](screenshots/task5_5.png)

Пропингуем ws22 с ws21. 
Аналогично пропингуем r1 с ws11.
![](screenshots/task5_6.png)

### 5.2. Включение переадресации IP-адресов

Для включения переадресации IP, выполним команду на роутерах:
sysctl -w net.ipv4.ip_forward=1
![](screenshots/task5_7.png)

При таком подходе переадресация не будет работать после перезагрузки системы (мы меняем параметр net.ipv4.ip_forward с 0 на 1)

Откроем файл /etc/sysctl.conf и добавим в него следующую строку:
net.ipv4.ip_forward = 1
При использовании этого подхода, IP-переадресация включена на постоянной основе.
![](screenshots/task5_8.png)

### 5.3. Установка маршрута по-умолчанию

Настроим маршрут по-умолчанию (шлюз) для рабочих станций
![](screenshots/task5_9.png)
![](screenshots/task5_10.png)

Вызовем ip r и покажем, что добавился маршрут в таблицу маршрутизации.
![](screenshots/task5_11.png)
![](screenshots/task5_12.png)

Пропингуем с ws11 роутер r2 и покажем на r2, что пинг доходит. Для этого используем команду:
tcpdump -tn -i eth0
![](screenshots/task5_13.png)
![](screenshots/task5_14.png)

### 5.4. Добавление статических маршрутов

Добавим в роутеры r1 и r2 статические маршруты в файле конфигураций. 
![](screenshots/task5_15.png)

Вызовем ip r и покажем таблицы с маршрутами на обоих роутерах.
![](screenshots/task5_16.png)

Запусти команды на ws11:
ip r list 10.10.0.0/[маска сети] и ip r list 0.0.0.0/0
![](screenshots/task5_17.png)

В отчёте объясни, почему для адреса 10.10.0.0/[маска сети] был выбран маршрут, отличный от 0.0.0.0/0, хотя он попадает под маршрут по-умолчанию.
Дело в том, что адрес 10.10.0.0 мало того, что является фиктивным (все биты хоста одинаковые = 0), так еще и является общим для всей представленной сети, поэтому данный адрес указывает на все адреса подсети.

### 5.5. Построение списка маршрутизаторов

Путь строиться от узла к узлу до того момента, покаа не будет достигнута конечная точка. Каждый пакет проходит на своем пути определенное количество узлов, пока достигнет своей цели. На каждом узле добавляется счетчик, который отслеживает количество пройденых узлов.
![](screenshots/task5_18.png)

### 5.6. Использование протокола ICMP при маршрутизации

Запустим на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды:
tcpdump -n -i eth0 icmp

Пропингуем с ws11 несуществующий IP (например, 10.30.0.111) с помощью команды:
ping -c 1 10.30.0.111

![](screenshots/task5_19.png)

## Part 6. Динамическая настройка IP с помощью DHCP

Для r2 настрой в файле /etc/dhcp/dhcpd.conf конфигурацию службы DHCP:

1) Укажи адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети. Пример файла для r2:

subnet 10.100.0.0 netmask 255.255.0.0 {}

subnet 10.20.0.0 netmask 255.255.255.192
{
    range 10.20.0.2 10.20.0.50;
    option routers 10.20.0.1;
    option domain-name-servers 10.20.0.1;
}

2) В файле resolv.conf пропиши nameserver 8.8.8.8.

В отчёт помести скрины с содержанием изменённых файлов.

![](screenshots/task6_1.png)
![](screenshots/task6_2.png)

Перезагрузи службу DHCP командой systemctl restart isc-dhcp-server. 

![](screenshots/task6_3.png)
Машину ws21 перезагрузи при помощи reboot и через ip a покажи, что она получила адрес. 

![](screenshots/task6_4.png)
Также пропингуй ws22 с ws21.

![](screenshots/task6_5.png)

Укажи MAC адрес у ws11, для этого в etc/netplan/00-installer-config.yaml надо добавить строки: macaddress: 10:10:10:10:10:BA, dhcp4: true.

![](screenshots/task6_6.png)

Для r1 настрой аналогично r2, но сделай выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Проведи аналогичные тесты.

![](screenshots/task6_7.png)
![](screenshots/task6_8.png)

Запроси с ws21 обновление ip адреса.

![](screenshots/task6_9.png)
![](screenshots/task6_10.png)

sudo dhclient -v 
sudp dhclient -r (Убивает старый)
sudo dhclient -v

## Part 7. NAT

В файле /etc/apache2/ports.conf на ws22 и r1 измени строку Listen 80 на Listen 0.0.0.0:80, то есть сделай сервер Apache2 общедоступным.

![](screenshots/task7_1.png)
![](screenshots/task7_2.png)

Запусти веб-сервер Apache командой service apache2 start на ws22 и r1.

![](screenshots/task7_3.png)

Добавь в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:

1) Удаление правил в таблице filter - iptables -F;

2) Удаление правил в таблице "NAT" - iptables -F -t nat;

3) Отбрасывать все маршрутизируемые пакеты - iptables --policy FORWARD DROP.

Запусти файл также, как в Части 4.

Проверь соединение между ws22 и r1 командой ping.
При запуске файла с этими правилами, ws22 не должна «пинговаться» с r1.

![](screenshots/task7_4.png)

Добавь в файл ещё одно правило:

4) Разрешить маршрутизацию всех пакетов протокола ICMP.

Запусти файл также, как в Части 4.

Проверь соединение между ws22 и r1 командой ping.
При запуске файла с этими правилами, ws22 должна «пинговаться» с r1.

![](screenshots/task7_5.png)

Добавь в файл ещё два правила:

5) Включи SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0).
Совет: стоит подумать о маршрутизации внутренних пакетов, а также внешних пакетов с установленным соединением.

6) Включи DNAT на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети.
Совет: стоит учесть, что при попытке подключения возникнет новое tcp-соединение, предназначенное ws22 и 80 порту.

![](screenshots/task7_8.png)

Запусти файл также, как в Части 4.
Перед тестированием рекомендуется отключить сетевой интерфейс NAT (его наличие можно проверить командой ip a) в VirtualBox, если он включен.

Проверь соединение по TCP для SNAT: для этого с ws22 подключиться к серверу Apache на r1 командой:
telnet [адрес] [порт]

Проверь соединение по TCP для DNAT: для этого с r1 подключиться к серверу Apache на ws22 командой telnet (обращаться по адресу r2 и порту 8080).

![](screenshots/task7_9.png)
![](screenshots/task7_10.png)

## Part 8. Дополнительно. Знакомство с SSH Tunnels

Запусти на r2 фаервол с правилами из Части 7.
Также к команде multiport необходимо будет добавить еще один порт (80), который будет проверяться в дальнейшем командой telnet 
![](screenshots/task8_11.png)

Запусти веб-сервер Apache на ws22 только на localhost (то есть в файле /etc/apache2/ports.conf измени строку Listen 80 на Listen localhost:80).

![](screenshots/task8_1.png)

Воспользуйся Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21.
Запустим ssh на машинах 21 и 22:
![](screenshots/task8_5.png)
На скиншоте также видно выполнение команды 
netstat -tulpan | grep ssh
Данная команда позволяет выцепить действующие TCP-соединения и статистику по протоколам. Утилита grep позволяет отфильтровать их по выполнению этого процесса. После этого можно определить, какие порты выделены для ssh
Как видно, порт 2233 на машине 21 не является дефолтным. Его можно занять командой 
nano /etc/ssh/sshd_config
и изменением порта в файле
![](screenshots/task8_3.png)

![](screenshots/task8_8.png)
![](screenshots/task8_9.png)

Воспользуйся Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11.

![](screenshots/task8_14.png)
![](screenshots/task8_15.png)

telnet для проверки:
![](screenshots/task8_10.png)
![](screenshots/task8_13.png)
